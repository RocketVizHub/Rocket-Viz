<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <title>Rocket Viz - Aperçu</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="script_stats.js"></script>
    <style>
        h1 {
            padding-top: 50px;
            padding-bottom: 20px;
        }
        .player1 {
            fill: #007BFF; 
            stroke: black; 
            stroke-width: 1; 
        }    
        .player1.hovered {
            opacity: 0.6;
        }
        .player2 {
            fill: #6C757D; 
            stroke: black; 
            stroke-width: 1; 
        }    
        .player2.hovered {
            opacity: 0.6;
        }
        .text-team-results {
            fill: white;
            font-weight: bold;
            font-size: 14px;
            font-family: sans-serif;
        }
        .text-row-name {
            fill: black;
            font-size: 20px;
            font-family: sans-serif;
        }
        text {
            pointer-events: none;
        }
    </style>
    <!-- <style>
        body {
            padding-top: 56px;
        }

        @media (min-width: 768px) {
            body {
                padding-top: 70px;
            }
        }
    </style> -->
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">Rocket Viz</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="stats.html">Stats</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="global_stats.html">Aperçu</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Table Section -->
    <div class="container mt-3" id="content">
        <h1> Aperçu de la partie </h1>

        <!-- Create an empty table with an id -->
        <table id="playerStatsTable" border="1" class="table table-bordered table-striped">
            <thead class="thead-dark">
                <tr>
                    <th></th>
                    <th>Score</th>
                    <th>Goals</th>
                    <th>Assists</th>
                    <th>Saves</th>
                    <th>Shots</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table body will be populated using D3 -->
            </tbody>
        </table>
    </div>
    

    </table>

    <script>
        d3.json("utils/replay03.json").then(function(data) {
            console.log(data.properties);

            var scoreTeam0;
            var scoreTeam1;

            if (typeof data.properties.Team0Score === "undefined") scoreTeam0 = 0;
            else scoreTeam0 = data.properties.Team0Score;
            if (typeof data.properties.Team1Score === "undefined") scoreTeam1 = 0;
            else scoreTeam1 = data.properties.Team1Score;

            
            var team0Stats = data.properties.PlayerStats.filter(player => player.Team === 0);
            var team1Stats = data.properties.PlayerStats.filter(player => player.Team === 1);

            
            // Add element at the beginning of the array, that is the team score
            team0Stats.unshift(scoreTeam0);
            team1Stats.unshift(scoreTeam1);
            var teamsStats = [team0Stats,team1Stats];

            var table = d3.select("#playerStatsTable");

            var tbody = table.select('tbody');

            function displayPlayerStats() {
                var rows = d3.select("#playerStatsTable")
                    .select('tbody')
                    .selectAll('tr')
                    .data(teamsStats)
                    .enter()

                var rows2 = rows.selectAll("tr")
                    .data(function (d) {    // joins inner array of each row
                        return d;
                    })
                    .enter()
                    .append('tr');

                    rows2.append('td')
                    .text(function(d) {
                        if (typeof d === "number" && Number.isInteger(d)) {
                            d3.select(this)
                                .classed('special-column', true)
                                .attr('colspan', 6)
                                .style('font-weight', 'bold')
                                .classed('text-light', true)
                                .classed('bg-primary', d === scoreTeam0)
                                .classed('bg-secondary', d === scoreTeam1);
                            return d;
                        } else {
                            return d.Name;
                        }
                    });

                    rows2.each(function(d) {
                        if (typeof d.Score !== "undefined") {
                            d3.select(this).append('td').text(d.Score);
                        }
                    });
                    rows2.each(function(d) {
                        if (typeof d.Goals !== "undefined") {
                            d3.select(this).append('td').text(d.Goals);
                        }
                    });
                    rows2.each(function(d) {
                        if (typeof d.Assists !== "undefined") {
                            d3.select(this).append('td').text(d.Assists);
                        }
                    });
                    rows2.each(function(d) {
                        if (typeof d.Saves !== "undefined") {
                            d3.select(this).append('td').text(d.Saves);
                        }
                    });
                    rows2.each(function(d) {
                        if (typeof d.Shots !== "undefined") {
                            d3.select(this).append('td').text(d.Shots);
                        }
                    });
            }

            displayPlayerStats();

            function sortTable(columnName) {
                var rows = d3.select("#playerStatsTable tbody tr");

                rows.sort(function(a, b) {
                    console.log("coucou2");
                    console.log(a, d3.select(a).datum());
                    var aValue = d3.select(a).datum()[columnName];
                    var bValue = d3.select(b).datum()[columnName];

                    return aValue - bValue;
                });

                // Mise à jour de l'affichage après le tri
                rows.transition().duration(500).attr("transform", function(d, i) {
                    return "translate(0," + i * 50 + ")";
                });
            }
            sortTable("Score");

            var overviewStats = getOverviewStats(data);
            // Afficher la clé et la valeur de chaque élément du tableau
            console.log(overviewStats);
            var width = d3.select("body").node().getBoundingClientRect().width;

            // Pour chaque élément de la map, on va l'aafficher sous forme de rectangle
            // On va afficher un rectangle par élément de la map défini de la manière suivante :
            // - la largeur du rectangle est proportionnelle à la valeur de l'élément
            // - la hauteur du rectangle est fixe
            // - la position du rectangle est définie par la position de l'élément dans la map
            // - la couleur du rectangle est définie par la valeur de l'élément
            // - le texte du rectangle est défini par la clé de l'élément
            // - la couleur du texte est définie par la valeur de l'élément
            // - la taille du texte est fixe
            // - la position du texte est définie par la position de l'élément dans la map
            // - la police du texte est fixe
            function displayOverviewStats() {
                var widthDelta = 125;
                var centrageVertical = 30;
                var svg = d3.select("#content").append("svg")
                    .attr("width", 1000)
                    .attr("height", 300);
                    
                var width = 1000;  // Ajout de la variable width pour référence

                // Rectangle pour les stats du joueur 1
                var rectanglesPlayer1 = svg.selectAll(".player1")
                    .data(overviewStats)
                    .enter()
                    .append("rect")
                    .attr("class", "player1")
                    .attr("y", function(d, i) {
                        return i * 50;
                    })
                    .attr("x", widthDelta)
                    .attr("width", function(d) {
                        var sum = d[1][0] + d[1][1];
                        return d[1][0] / sum * (width - widthDelta);
                    })
                    .attr("height", 50)
                    .attr("fill", function(d) {
                        return d[1][0] * 10;
                    });
                
                var texts = svg.selectAll("text")
                    .data(overviewStats)
                    .enter();
                
                var textTeam1 = texts
                    .append("text")
                    .attr("class", "text-team-results")
                    .text(function(d) {
                        return d[1][0]; // Valeur de la team 1
                    })
                    .attr("y", function(d, i) {
                        return i * 50 + centrageVertical;  // Ajuster pour le centrage vertical
                    })
                    .attr("x", widthDelta + 15);
                    
                rectanglesPlayer1.on("mouseover", function(e, d) {
                        var rect = d3.select(this)
                            .classed("hovered", true);

                        var rectWidth = parseFloat(d3.select(this).attr("width"));

                        var percentage = d[1][0] / (d[1][0] + d[1][1]) * 100;
                        percentage = Math.round(percentage * 100) / 100;
                        var percentageText = svg.append("text")
                            .text(percentage + "%")
                            .attr("x", parseFloat(d3.select(this).attr("x")) + rectWidth - 60)
                            .attr("y", parseFloat(d3.select(this).attr("y")) + centrageVertical)
                            .attr("class", "percentage-text");
                    });
                rectanglesPlayer1.on("mouseout", function(e, d) {
                    var rect = d3.select(this);

                    // Supprimer la classe pour le survol
                    rect.classed("hovered", false);
                    // Supprimer le texte pour le pourcentage
                    svg.select(".percentage-text").remove();
                });

                // Rectangle pour les stats du joueur 2
                var rectanglesPlayer2 = svg.selectAll(".player2")
                    .data(overviewStats)
                    .enter()
                    .append("rect")
                    .attr("class", "player2")
                    .attr("y", function(d, i) {
                        return i * 50;
                    })
                    .attr("x", function(d) {
                        var sum = d[1][0] + d[1][1];
                        return width - (d[1][1] / sum * (width - widthDelta));
                    })
                    .attr("width", function(d) {
                        var sum = d[1][0] + d[1][1];
                        return d[1][1] / sum * (width - widthDelta);
                    })
                    .attr("height", 50)
                    .attr("fill", function(d) {
                        return d[1][1] * 10;
                    });
                var textTeam2 = texts
                    .append("text")
                    .attr("class", "text-team-results")
                    .text(function(d) {
                        return d[1][1]; // Valeur de la team 1
                    })
                    .attr("y", function(d, i) {
                        return i * 50 + centrageVertical;  // Ajuster pour le centrage vertical
                    })
                    .attr("x", width - 30);
                rectanglesPlayer2.on("mouseover", function(e, d) {
                        var rect = d3.select(this)
                            .classed("hovered", true);
                        var percentage = d[1][1] / (d[1][0] + d[1][1]) * 100;
                        percentage = Math.round(percentage * 100) / 100;
                        var percentageText = svg.append("text")
                            .text(percentage + "%")
                            .attr("x", parseFloat(d3.select(this).attr("x")) + 10)
                            .attr("y", parseFloat(d3.select(this).attr("y")) + centrageVertical)
                            .attr("class", "percentage-text");
                    });
                rectanglesPlayer2.on("mouseout", function(e, d) {
                    var rect = d3.select(this);
                    rect.classed("hovered", false);
                    svg.select(".percentage-text").remove();
                });

                // Texte pour les noms des joueurs
                var textRowName = texts
                    .append("text")
                    .text(function(d) {
                        return d[0];
                    })
                    .attr("y", function(d, i) {
                        return i * 50 + centrageVertical;
                    })
                    .attr("x", 50)
                    .attr("class", "text-row-name");
            }

            function loadMapElements(value, key, map) {
                console.log(key);
                console.log(map.get(key));
                console.log(`m[${key}] = ${value}`);
            }

            // overviewStats.forEach(loadMapElements);

            d3.selectAll("#content").append("h1").text("Statistiques par équipe");
            displayOverviewStats();

            console.log(data.network_frames.frames[0].new_actors[0].attribute);

            // Parcourir le tableau data.network_frames.frames[0].new_actors jusqu'à trouver l'attribut "attribute"
            
            console.log("Nombre de frames : " + data.network_frames.frames.length);
            console.log(data.network_frames.frames);
            var sumTeam0 = 0;
            var sumTeam1 = 0;
            // data.network_frames.frames.forEach(frame => {
            //     var test = 0;
            //     frame.updated_actors.forEach(actor => {
            //         // console.log(element);
            //         if (typeof actor.attribute !== "undefined") {
            //             // console.log("ta mere", typeof actor.attribute);
            //             // console.log(actor.attribute);
            //             var element = actor.attribute;
            //             if (typeof element.TeamPaint !== "undefined") {
            //                 // console.log("cc ", element.TeamPaint);
            //                 if (element.TeamPaint.team === 0) {
            //                     sumTeam0++;
            //                     test++;
            //                 } else if (element.TeamPaint.team === 1) {
            //                     sumTeam1++;
            //                     test++;
            //                 }
            //             }
            //         }

            //         // if (element.actor_id == 7) {
            //         //     console.log("7");
            //         // } 
            //         // if (element.object_id == 269) {
            //         //     console.log("269");
            //         // }
            //     });
                
            //     console.log(test);
            // });

            console.log("Somme team 0 : " + sumTeam0);
            console.log("Somme team 1 : " + sumTeam1);

            console.log(getLocations(data, 0));

            var locationBall = getLocations(data, 0);

            var sumXneg = 0;
            var sumXpos = 0;

            locationBall.forEach(location => {
                // console.log(location[1].x);
                if (location[1].x < 0) {
                    sumXneg++;
                } else if (location[1].x > 0) {
                    sumXpos++;
                }
            });

            console.log("Somme X neg : " + sumXneg);
            console.log("Somme X pos : " + sumXpos);

            // Créer un diagramme circulaire avec sumXneg étant le nombre de fois où la balle est dans le camp de la team 0
            // et sumXpos étant le nombre de fois où la balle est dans le camp de la team 1

            // var width = 500;
            // var height = 500;
            // var radius = Math.min(width, height) / 2;

            // var svg_ball = d3.select("#content").append("svg")
            //     .attr("width", width)
            //     .attr("height", height)
            //     .append("g")
            //     .attr("transform",
            //     "translate(" + width / 2 + "," + height / 2 + ")");

            var data_ball = [
                { team: 'Team1', count: sumXneg },
                { team: 'Team2', count: sumXpos },
            ];

            getPieData = d3.pie()
                .value(function(d) { console.log(d.value); return d.count; });
            var pieData = getPieData(data_ball);

            function displayCircularDiagram() {
                const width = 600;
                const height = 400;
                
                const svg = d3.select("#content").append("svg")
                    .attr('width', width)
                    .attr('height', height);

                // On utilise la fonction d3.arc qui va s'occuper de
                // déssiner les arcs de cercle pour nous
                const arcCreator = d3.arc()
                    .innerRadius(0)
                    .outerRadius(height / 2)
                
                // une échelle pour la couleur, comme vu plus haut
                // (en utilisant une palette de couleur catégorielle)
                const colors = d3.scaleOrdinal()
                    .domain(data_ball.map(d => d.team))
                    .range(d3.schemePastel1)
                
                // un groupe pour centrer le camembert
                const pie = svg.append('g')
                    .attr('transform', `translate(${height / 2}, ${height / 2})`)

                pie.selectAll('path')
                    .data(pieData)
                    .enter()
                    .append('path') // Cette fois on utilise un chemin ('path') et non plus un 'rect' ou un 'circle'
                    .attr('d', arcCreator) // La fonction responsable de dessiner le chemin pour les données actuelle
                    .attr('fill', function(d) {
                        if (d.data.team === "Team1") {
                            return "#007BFF";
                        } else if (d.data.team === "Team2") {
                            return "#6C757D";
                        }
                    })
                    .on('mouseover', (event, d) => {
                        // On sélectionne le texte grace à sa classe
                        // et on modifie la valeur d'opacité
                        d3.select(`.text-${d.data.team}`)
                            .attr('opacity', 1);
                    })
                    .on('mouseout', (event, d) => {
                        // On sélectionne le texte grace à sa classe
                        // et on modifie la valeur d'opacité
                        d3.select(`.text-${d.data.team}`)
                            .attr('opacity', 0);
                    });

                // On ajoute un texte avec le nombre de team concerné pour chaque secteur
                // mais on définie l'opacité à 0
                // Cette opacité sera modifié (à 1) lors du survol sur le secteur correspondant
                pie.selectAll('text')
                    .data(pieData)
                    .enter()
                    .append('text')
                    // On met un nom de classe différent pour chaque texte, 
                    // pour permettre de sélectionner le bon texte
                    // dans les gestionnaire d'événement mouseover / mouseout
                    .attr('class', (d) => `text-${d.data.team}`)
                    // .centroid permet de trouver le centre de la tranche
                    .attr('transform', d => `translate(${arcCreator.centroid(d)})`)
                    .attr('text-anchor', 'middle')
                    .attr('opacity', 0)
                    .text(function(d) {
                        var percentage = d.data.count / (sumXneg + sumXpos) * 100;
                        percentage = Math.round(percentage * 100) / 100;
                        return percentage + "%";
                    });

                // On va également créer une légende
                // Pour cela, on va lié un tableau contenant le nom des teams
                // avec des rectangles et des textes
                const legend = svg.append('g')
                    .attr('transform', `translate(${height-10})`)
                
                const rectWidth = 20
                
                // On va réutiliser l'échelle de couleurs, comme lors du dessin des secteurs
                legend.selectAll('rect')
                    .data(pieData)
                    .enter()
                    .append('rect')
                    .attr('x', 0)
                    .attr('y', (d, i) => i * rectWidth)
                    .attr('width', rectWidth)
                    .attr('height', rectWidth)
                    .attr('fill', (d) => colors(d.data.team));
                
                // les noms de teams
                legend.selectAll('text')
                    .data(pieData)
                    .enter()
                    .append('text')
                    .attr('x', rectWidth * 1.5)
                    .attr('y', (d, i) => i * rectWidth + rectWidth * 0.75)
                    .text(d => d.data.team);
                
                return svg.node()
            }
            d3.selectAll("#content").append("h1").text("Pressure");
            d3.selectAll("#content")
                .append("p")
                .text("Pressure is a measure of how much time the ball spends on a side.");
            displayCircularDiagram();



        });
    </script>
</body>